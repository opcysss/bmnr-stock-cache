name: Update BMNR Stock Data

on:
  schedule:
    - cron: '*/2 14-21 * * 1-5'
    - cron: '*/10 0-14,21-23 * * 1-5'
    - cron: '*/30 * * * 0,6'
  workflow_dispatch:

jobs:
  update-stock-data:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Fetch Stock and Crypto Data
        env:
          TWELVEDATA_API_KEY: ${{ secrets.TWELVEDATA_API_KEY }}
        run: |
          TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          echo "ðŸ“… Timestamp: $TIMESTAMP"
          
          echo "ðŸ”„ Fetching Ethereum price..."
          ETH_DATA=$(curl -s "https://api.coingecko.com/api/v3/simple/price?ids=ethereum&vs_currencies=usd")
          ETH_PRICE=$(echo $ETH_DATA | jq -r '.ethereum.usd')
          echo "âœ… ETH Price: $ETH_PRICE"
          
          echo "ðŸ”„ Fetching Ethereum supply data..."
          ETH_SUPPLY_DATA=$(curl -s "https://api.coingecko.com/api/v3/coins/ethereum?localization=false&tickers=false&community_data=false&developer_data=false")
          ETH_CIRCULATING=$(echo $ETH_SUPPLY_DATA | jq -r '.market_data.circulating_supply // 120430000')
          ETH_TOTAL=$(echo $ETH_SUPPLY_DATA | jq -r '.market_data.total_supply // 120430000')
          echo "âœ… ETH Circulating Supply: $ETH_CIRCULATING"
          echo "âœ… ETH Total Supply: $ETH_TOTAL"
          
          echo "ðŸ”„ Fetching BMNR stock price..."
          STOCK_DATA=$(curl -s "https://api.twelvedata.com/quote?symbol=BMNR&apikey=$TWELVEDATA_API_KEY")
          echo "ðŸ“Š Stock Response: $STOCK_DATA"
          
          STOCK_SYMBOL=$(echo $STOCK_DATA | jq -r '.symbol // "BMNR"')
          STOCK_PRICE=$(echo $STOCK_DATA | jq -r '.close // "29.32"')
          STOCK_CHANGE=$(echo $STOCK_DATA | jq -r '.change // "-2.07"')
          STOCK_PERCENT=$(echo $STOCK_DATA | jq -r '.percent_change // "-6.59"')
          STOCK_PREV_CLOSE=$(echo $STOCK_DATA | jq -r '.previous_close // "31.39"')
          
          echo "âœ… Stock Price: $STOCK_PRICE"
          
          cat > stock_data.json << EOF
          {
            "timestamp": "$TIMESTAMP",
            "ethereum": $ETH_PRICE,
            "eth_circulating_supply": $ETH_CIRCULATING,
            "eth_total_supply": $ETH_TOTAL,
            "stock": {
              "symbol": "$STOCK_SYMBOL",
              "price": "$STOCK_PRICE",
              "change": "$STOCK_CHANGE",
              "percent_change": "$STOCK_PERCENT",
              "previous_close": "$STOCK_PREV_CLOSE"
            }
          }
          EOF
          
          echo "âœ… stock_data.json created"
          cat stock_data.json
      
      - name: Commit and Push changes
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "GitHub Actions Bot"
          git add stock_data.json
          
          if git diff --staged --quiet; then
            echo "â­ï¸ No changes"
          else
            git commit -m "ðŸ”„ Update stock data - $(date -u +"%Y-%m-%d %H:%M UTC")"
            git push
            echo "âœ… Pushed"
          fi
